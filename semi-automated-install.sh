#!/usr/bin/env bash

# –ü–æ–ª—É–∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è —É—Å—Ç–∞–Ω–æ–≤–∫–∞ NixOS —Å –ø—Ä–æ–≤–µ—Ä–∫–∞–º–∏ –Ω–∞ –∫–∞–∂–¥–æ–º —ç—Ç–∞–ø–µ
# –ë–æ–ª–µ–µ –±–µ–∑–æ–ø–∞—Å–Ω–∞—è –∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–∞ –ø–æ–ª–Ω–æ—Å—Ç—å—é –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–π —É—Å—Ç–∞–Ω–æ–≤–∫–µ

set -euo pipefail

# –¶–≤–µ—Ç–∞
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m'

info() { echo -e "${BLUE}‚ÑπÔ∏è  $1${NC}"; }
success() { echo -e "${GREEN}‚úÖ $1${NC}"; }
warning() { echo -e "${YELLOW}‚ö†Ô∏è  $1${NC}"; }
error() { echo -e "${RED}‚ùå $1${NC}"; exit 1; }

pause() {
    read -p "–ù–∞–∂–º–∏—Ç–µ Enter –¥–ª—è –ø—Ä–æ–¥–æ–ª–∂–µ–Ω–∏—è –∏–ª–∏ Ctrl+C –¥–ª—è –≤—ã—Ö–æ–¥–∞..."
}

if [ "$EUID" -ne 0 ]; then
    error "–ó–∞–ø—É—Å—Ç–∏—Ç–µ —Å sudo"
fi

echo "‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê"
echo "üîß –ü–æ–ª—É–∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è —É—Å—Ç–∞–Ω–æ–≤–∫–∞ NixOS"
echo "   –° –ø—Ä–æ–≤–µ—Ä–∫–∞–º–∏ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏ –Ω–∞ –∫–∞–∂–¥–æ–º —ç—Ç–∞–ø–µ"
echo "‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê"
echo

# –≠—Ç–∞–ø 1: –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–µ—Ç–∏
info "–≠—Ç–∞–ø 1/8: –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–µ—Ç–∏"
if ping -c 1 8.8.8.8 >/dev/null 2>&1; then
    success "–ò–Ω—Ç–µ—Ä–Ω–µ—Ç –ø–æ–¥–∫–ª—é—á–µ–Ω"
else
    error "–ù–∞—Å—Ç—Ä–æ–π—Ç–µ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç –∏ –ø–æ–≤—Ç–æ—Ä–∏—Ç–µ"
fi
pause

# –≠—Ç–∞–ø 2: –í—ã–±–æ—Ä –¥–∏—Å–∫–∞
info "–≠—Ç–∞–ø 2/8: –í—ã–±–æ—Ä –¥–∏—Å–∫–∞ –¥–ª—è —É—Å—Ç–∞–Ω–æ–≤–∫–∏"
echo
lsblk
echo
warning "–í—ã–±–µ—Ä–∏—Ç–µ –¥–∏—Å–∫ –¥–ª—è —É—Å—Ç–∞–Ω–æ–≤–∫–∏ NixOS"
echo "–ü—Ä–∏–º–µ—Ä: /dev/nvme0n1 –¥–ª—è NVMe SSD"
read -p "–í–≤–µ–¥–∏—Ç–µ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ (–Ω–∞–ø—Ä–∏–º–µ—Ä /dev/nvme0n1): " DISK

if [ ! -b "$DISK" ]; then
    error "–£—Å—Ç—Ä–æ–π—Å—Ç–≤–æ $DISK –Ω–µ –Ω–∞–π–¥–µ–Ω–æ"
fi

echo
warning "–í–ù–ò–ú–ê–ù–ò–ï: –î–∏—Å–∫ $DISK –±—É–¥–µ—Ç –ø–æ–ª–Ω–æ—Å—Ç—å—é –æ—á–∏—â–µ–Ω!"
lsblk "$DISK"
echo
read -p "–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç–µ –≤—ã–±–æ—Ä –¥–∏—Å–∫–∞ $DISK (–≤–≤–µ–¥–∏—Ç–µ 'confirm'): " CONFIRM
if [ "$CONFIRM" != "confirm" ]; then
    error "–£—Å—Ç–∞–Ω–æ–≤–∫–∞ –æ—Ç–º–µ–Ω–µ–Ω–∞"
fi
pause

# –≠—Ç–∞–ø 3: –†–∞–∑–º–µ—Ç–∫–∞ –¥–∏—Å–∫–∞
info "–≠—Ç–∞–ø 3/8: –†–∞–∑–º–µ—Ç–∫–∞ –¥–∏—Å–∫–∞"
echo "–ë—É–¥–µ—Ç —Å–æ–∑–¥–∞–Ω–∞ —Å–ª–µ–¥—É—é—â–∞—è —Ä–∞–∑–º–µ—Ç–∫–∞:"
echo "‚Ä¢ EFI Boot: 512MB"
echo "‚Ä¢ LUKS –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä: –æ—Å—Ç–∞–ª—å–Ω–æ–µ –º–µ—Å—Ç–æ"
echo "  ‚îú‚îÄ‚îÄ Root: 60GB (ext4)"
echo "  ‚îú‚îÄ‚îÄ Home: ~400GB (ext4)" 
echo "  ‚îî‚îÄ‚îÄ Swap: 32GB (–¥–ª—è –≥–∏–±–µ—Ä–Ω–∞—Ü–∏–∏)"
echo

pause

wipefs -a "$DISK"
(
echo g # GPT
echo n; echo 1; echo; echo +512M  # EFI
echo n; echo 2; echo; echo        # LUKS  
echo t; echo 1; echo 1            # EFI type
echo w
) | fdisk "$DISK"

# –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ —Ä–∞–∑–¥–µ–ª–æ–≤
if [[ "$DISK" =~ nvme ]]; then
    EFI="${DISK}p1"
    LUKS="${DISK}p2"
else
    EFI="${DISK}1" 
    LUKS="${DISK}2"
fi

success "–î–∏—Å–∫ —Ä–∞–∑–º–µ—á–µ–Ω: EFI=$EFI, LUKS=$LUKS"
pause

# –≠—Ç–∞–ø 4: –ù–∞—Å—Ç—Ä–æ–π–∫–∞ —à–∏—Ñ—Ä–æ–≤–∞–Ω–∏—è
info "–≠—Ç–∞–ø 4/8: –ù–∞—Å—Ç—Ä–æ–π–∫–∞ LUKS —à–∏—Ñ—Ä–æ–≤–∞–Ω–∏—è"
warning "–ü—Ä–∏–¥—É–º–∞–π—Ç–µ –ù–ê–î–ï–ñ–ù–´–ô –ø–∞—Ä–æ–ª—å –¥–ª—è —à–∏—Ñ—Ä–æ–≤–∞–Ω–∏—è –¥–∏—Å–∫–∞"
echo

cryptsetup luksFormat "$LUKS"
cryptsetup luksOpen "$LUKS" nixos-root

success "LUKS –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä —Å–æ–∑–¥–∞–Ω –∏ –æ—Ç–∫—Ä—ã—Ç"
pause

# –≠—Ç–∞–ø 5: –°–æ–∑–¥–∞–Ω–∏–µ —Ñ–∞–π–ª–æ–≤—ã—Ö —Å–∏—Å—Ç–µ–º
info "–≠—Ç–∞–ø 5/8: –°–æ–∑–¥–∞–Ω–∏–µ —Ñ–∞–π–ª–æ–≤—ã—Ö —Å–∏—Å—Ç–µ–º"

# EFI
mkfs.fat -F 32 -n BOOT "$EFI"

# LVM
pvcreate /dev/mapper/nixos-root
vgcreate vg0 /dev/mapper/nixos-root
lvcreate -L 32G -n swap vg0
lvcreate -L 60G -n root vg0  
lvcreate -l 100%FREE -n home vg0

# –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ
mkfs.ext4 -L NIXOS /dev/vg0/root
mkfs.ext4 -L HOME /dev/vg0/home
mkswap -L SWAP /dev/vg0/swap

success "–§–∞–π–ª–æ–≤—ã–µ —Å–∏—Å—Ç–µ–º—ã —Å–æ–∑–¥–∞–Ω—ã"
lvdisplay
pause

# –≠—Ç–∞–ø 6: –ú–æ–Ω—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ
info "–≠—Ç–∞–ø 6/8: –ú–æ–Ω—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Ñ–∞–π–ª–æ–≤—ã—Ö —Å–∏—Å—Ç–µ–º"

mount /dev/vg0/root /mnt
mkdir -p /mnt/boot /mnt/home
mount "$EFI" /mnt/boot
mount /dev/vg0/home /mnt/home
swapon /dev/vg0/swap

success "–§–∞–π–ª–æ–≤—ã–µ —Å–∏—Å—Ç–µ–º—ã —Å–º–æ–Ω—Ç–∏—Ä–æ–≤–∞–Ω—ã"
df -h /mnt*
pause

# –≠—Ç–∞–ø 7: –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –∏ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏
info "–≠—Ç–∞–ø 7/8: –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ NixOS"

# –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º hardware config
nixos-generate-config --root /mnt

echo "–•–æ—Ç–∏—Ç–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –≥–æ—Ç–æ–≤—É—é –æ–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—É—é –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é?"
echo "1) –î–∞ - —Å–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å –≥–æ—Ç–æ–≤—ã–µ —Ñ–∞–π–ª—ã flake.nix, configuration.nix, home.nix"
echo "2) –ù–µ—Ç - —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—É—é configuration.nix –≤—Ä—É—á–Ω—É—é"
read -p "–í—ã–±–µ—Ä–∏—Ç–µ (1/2): " CONFIG_CHOICE

case $CONFIG_CHOICE in
    1)
        info "–ö–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ –æ–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω–æ–π –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏..."
        
        # –û–ø—Ä–µ–¥–µ–ª—è–µ–º –ø—É—Ç—å –∫ –∏—Å—Ö–æ–¥–Ω—ã–º —Ñ–∞–π–ª–∞–º
        SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
        
        if [ -f "$SCRIPT_DIR/flake.nix" ]; then
            cp "$SCRIPT_DIR/flake.nix" /mnt/etc/nixos/
            cp "$SCRIPT_DIR/configuration.nix" /mnt/etc/nixos/
            cp "$SCRIPT_DIR/home.nix" /mnt/etc/nixos/
            
            # –û–±–Ω–æ–≤–ª—è–µ–º LUKS —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ –≤ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏
            sed -i "s|device = \".*\";|device = \"$LUKS\";|" /mnt/etc/nixos/configuration.nix
            
            success "–û–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω–∞—è –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∞"
        else
            warning "–§–∞–π–ª—ã –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã –≤ —Ç–µ–∫—É—â–µ–π –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏"
            warning "–ë—É–¥–µ—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∞ —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–∞—è –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è"
            nano /mnt/etc/nixos/configuration.nix
        fi
        ;;
    2)
        info "–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–æ–π –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏..."
        warning "–ù–µ –∑–∞–±—É–¥—å—Ç–µ —Ä–∞—Å–∫–æ–º–º–µ–Ω—Ç–∏—Ä–æ–≤–∞—Ç—å –Ω—É–∂–Ω—ã–µ –æ–ø—Ü–∏–∏:"
        echo "‚Ä¢ boot.loader.systemd-boot.enable = true;"
        echo "‚Ä¢ networking.networkmanager.enable = true;"
        echo "‚Ä¢ users.users.yourusername = {...};"
        echo "‚Ä¢ services.xserver.enable = true; (–µ—Å–ª–∏ –Ω—É–∂–µ–Ω)"
        pause
        nano /mnt/etc/nixos/configuration.nix
        ;;
esac

success "–ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –ø–æ–¥–≥–æ—Ç–æ–≤–ª–µ–Ω–∞"
pause

# –≠—Ç–∞–ø 8: –£—Å—Ç–∞–Ω–æ–≤–∫–∞
info "–≠—Ç–∞–ø 8/8: –£—Å—Ç–∞–Ω–æ–≤–∫–∞ NixOS"

if [ -f "/mnt/etc/nixos/flake.nix" ]; then
    info "–£—Å—Ç–∞–Ω–æ–≤–∫–∞ —Å flake –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–µ–π..."
    cd /mnt/etc/nixos
    nixos-install --flake .#PC-NixOS --no-root-passwd
else
    info "–£—Å—Ç–∞–Ω–æ–≤–∫–∞ —Å–æ —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–æ–π –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–µ–π..."
    nixos-install --no-root-passwd
fi

success "üéâ NixOS —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞ —É—Å–ø–µ—à–Ω–æ!"

echo
echo "‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê"
echo "‚úÖ –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞!"
echo
echo "üìã –°–ª–µ–¥—É—é—â–∏–µ —à–∞–≥–∏:"
echo "1. –£—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ –ø–∞—Ä–æ–ª—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –ø–æ—Å–ª–µ –ø–µ—Ä–≤–æ–π –∑–∞–≥—Ä—É–∑–∫–∏"  
echo "2. –ü—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –≤–≤–µ–¥–∏—Ç–µ –ø–∞—Ä–æ–ª—å LUKS –¥–ª—è —Ä–∞—Å—à–∏—Ñ—Ä–æ–≤–∫–∏ –¥–∏—Å–∫–∞"
echo "3. –°–∏—Å—Ç–µ–º–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –≤–æ–π–¥–µ—Ç –≤ —Å–∏—Å—Ç–µ–º—É"
echo
echo "üîß –ü–æ–ª–µ–∑–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã:"
echo "‚Ä¢ nixos-rebuild switch  - –ø—Ä–∏–º–µ–Ω–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏"
echo "‚Ä¢ nix-collect-garbage -d - –æ—á–∏—Å—Ç–∏—Ç—å —Å—Ç–∞—Ä—ã–µ –ø–æ–∫–æ–ª–µ–Ω–∏—è"
echo "‚Ä¢ fastfetch - –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —Å–∏—Å—Ç–µ–º–µ"
echo "‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê"

# –û—á–∏—Å—Ç–∫–∞
info "–†–∞–∑–º–æ–Ω—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ..."
umount -R /mnt
swapoff /dev/vg0/swap
vgchange -a n vg0
cryptsetup luksClose nixos-root

warning "–ò–∑–≤–ª–µ–∫–∏—Ç–µ —É—Å—Ç–∞–Ω–æ–≤–æ—á–Ω—ã–π –Ω–æ—Å–∏—Ç–µ–ª—å –∏ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∏—Ç–µ—Å—å"
read -p "–ü–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∏—Ç—å —Å–µ–π—á–∞—Å? (y/N): " REBOOT
if [[ $REBOOT =~ ^[Yy]$ ]]; then
    reboot
fi